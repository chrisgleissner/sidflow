name: Nightly Performance Tests

on:
  schedule:
    # Run every night at 2:00 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  performance:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.1
      
      - name: Cache HVSC collection
        uses: actions/cache@v4
        with:
          path: |
            workspace/hvsc
            workspace/hvsc-version.json
          key: hvsc-${{ hashFiles('.sidflow.json') }}
          restore-keys: |
            hvsc-
      
      - name: Install dependencies
        run: bun install --frozen-lockfile
      
      - name: Install k6
        run: |
          K6_VERSION=0.52.0
          curl -fsSL "https://github.com/grafana/k6/releases/download/v${K6_VERSION}/k6-v${K6_VERSION}-linux-amd64.tar.gz" -o /tmp/k6.tar.gz
          tar -xzf /tmp/k6.tar.gz -C /tmp
          sudo install -m 0755 /tmp/k6-v${K6_VERSION}-linux-amd64/k6 /usr/local/bin/k6
          rm -rf /tmp/k6.tar.gz /tmp/k6-v${K6_VERSION}-linux-amd64
      
      - name: Build project
        run: bun run build
        env:
          SIDFLOW_SKIP_WASM_UPSTREAM_CHECK: '1'

      - name: Build web app
        run: cd packages/sidflow-web && npm run build
      
      - name: Install Playwright browsers
        run: cd packages/sidflow-web && npx playwright install chromium
      
      - name: Start web server
        run: |
          cd packages/sidflow-web
          PORT=3000 npm run start -- --hostname 0.0.0.0 --port 3000 > /tmp/perf-server.log 2>&1 &
          echo $! > /tmp/perf-server.pid
          sleep 10

      - name: Run unified performance runner (Playwright + k6)
        run: npm run perf:run -- --env ci --base-url http://localhost:3000 --results performance/results --tmp performance/tmp --execute
        env:
          CI: true
          SIDFLOW_SKIP_WASM_UPSTREAM_CHECK: '1'
      
      - name: Stop web server
        if: always()
        run: |
          if [ -f /tmp/perf-server.pid ]; then
            kill $(cat /tmp/perf-server.pid) || true
          fi
          tail -n 200 /tmp/perf-server.log || true
      
      - name: Upload performance metrics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-metrics-${{ github.run_number }}
          path: |
            performance/results/
            performance/tmp/
            packages/sidflow-web/playwright-report/
          retention-days: 30
      
      - name: Upload performance report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-report-${{ github.run_number }}
          path: |
            performance/results/**/report.md
            performance/results/**/summary/summary.json
          retention-days: 90
      
      - name: Comment PR with performance results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Find the latest performance report
            const perfDir = 'tmp/performance';
            const files = fs.readdirSync(perfDir).filter(f => f.endsWith('.md'));
            
            if (files.length > 0) {
              const latestReport = files.sort().reverse()[0];
              const reportPath = path.join(perfDir, latestReport);
              const report = fs.readFileSync(reportPath, 'utf8');
              
              // Truncate if too long for GitHub comment
              const maxLength = 65000;
              const truncatedReport = report.length > maxLength 
                ? report.substring(0, maxLength) + '\n\n... (truncated)'
                : report;
              
              await github.rest.issues.createComment({
                ...context.repo,
                issue_number: context.issue.number,
                body: `## ðŸš€ Performance Test Results\n\n${truncatedReport}`
              });
            }
