name: Nightly Performance Tests

on:
  schedule:
    # Run every night at 2:00 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  performance:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.1
      
      - name: Cache HVSC collection
        uses: actions/cache@v4
        with:
          path: |
            workspace/hvsc
            workspace/hvsc-version.json
          key: hvsc-${{ hashFiles('.sidflow.json') }}
          restore-keys: |
            hvsc-
      
      - name: Install dependencies
        run: bun install --frozen-lockfile
      
      - name: Build project
        run: bun run build
        env:
          SIDFLOW_SKIP_WASM_UPSTREAM_CHECK: '1'
      
      - name: Install Playwright browsers
        run: cd packages/sidflow-web && npx playwright install chromium
      
      - name: Run performance tests
        run: bun run test:perf
        env:
          CI: true
          SIDFLOW_CONFIG: ${{ github.workspace }}/.sidflow.test.json
          SIDFLOW_SKIP_WASM_UPSTREAM_CHECK: '1'
      
      - name: Upload performance metrics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-metrics-${{ github.run_number }}
          path: |
            tmp/performance/
            packages/sidflow-web/playwright-report/
          retention-days: 30
      
      - name: Upload performance report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-report-${{ github.run_number }}
          path: tmp/performance/*.md
          retention-days: 90
      
      - name: Comment PR with performance results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Find the latest performance report
            const perfDir = 'tmp/performance';
            const files = fs.readdirSync(perfDir).filter(f => f.endsWith('.md'));
            
            if (files.length > 0) {
              const latestReport = files.sort().reverse()[0];
              const reportPath = path.join(perfDir, latestReport);
              const report = fs.readFileSync(reportPath, 'utf8');
              
              // Truncate if too long for GitHub comment
              const maxLength = 65000;
              const truncatedReport = report.length > maxLength 
                ? report.substring(0, maxLength) + '\n\n... (truncated)'
                : report;
              
              await github.rest.issues.createComment({
                ...context.repo,
                issue_number: context.issue.number,
                body: `## ðŸš€ Performance Test Results\n\n${truncatedReport}`
              });
            }
