# Performance Metrics and Progress Reporting

SIDFlow's `sidflow-classify` command provides real-time progress updates and detailed performance metrics for both WAV cache building and auto-tagging operations. These features help you understand the efficiency of classification runs and monitor progress during long-running operations.

## Real-Time Progress Updates

During classification, SIDFlow displays concise progress information on stdout:

### Initial Information
- **Thread count**: Displayed once at startup (e.g., "Starting classification (threads: 4)")

### WAV Cache Build Progress
- **Analysis phase**: Quick scan to determine which files need conversion
  - Shows files analyzed, total files, percentage complete, elapsed time
  - Example: `[Analyzing] 150/500 files (30.0%) - 0.52s`

- **Building phase**: Actual WAV file conversion
  - Shows files rendered, files cached, files remaining, percentage complete, current file, elapsed time
  - Example: `[Converting] 50 rendered, 100 cached, 350 remaining (30.0%) - song.sid - 15.23s`
  - Progress updates are throttled to avoid overwhelming output (max 2 updates/second)

### Auto-Tagging Progress
- **Metadata phase**: Extracting metadata from SID files
  - Example: `[Metadata] 75/150 files, 75 remaining (50.0%) - track.sid - 5.12s`

- **Tagging phase**: Generating predictions for untagged dimensions
  - Example: `[Tagging] 75/150 files, 75 remaining (50.0%) - track.sid - 8.45s`

## File Hash-Based Caching

SIDFlow uses intelligent caching to avoid unnecessary WAV conversions:

1. **Timestamp check**: If the SID file's timestamp is older than the WAV file, skip conversion
2. **Hash-based verification**: If timestamp changed but file content is identical (verified via SHA-256 hash), skip conversion
3. **Hash storage**: SHA-256 hash of each SID file is stored in `{wavfile}.hash` after successful conversion
4. **Smart updates**: Only files with actual content changes trigger WAV regeneration

This ensures that operations like git checkouts or file system moves don't trigger unnecessary reconversions.

## Metrics Types

### WAV Cache Build Metrics

The `buildWavCache` function returns metrics that include:

- **`startTime`**: Unix timestamp (milliseconds) when the operation started
- **`endTime`**: Unix timestamp (milliseconds) when the operation completed
- **`durationMs`**: Total duration of the operation in milliseconds
- **`totalFiles`**: Total number of SID files processed
- **`rendered`**: Number of WAV files newly rendered
- **`skipped`**: Number of WAV files skipped (already cached and fresh)
- **`cacheHitRate`**: Percentage of files served from cache (0.0 to 1.0)

A high cache hit rate (close to 1.0) indicates that most SID files haven't changed since the last WAV cache build, which significantly speeds up subsequent classification runs.

### Auto-Tagging Metrics

The `generateAutoTags` function returns metrics that include:

- **`startTime`**: Unix timestamp (milliseconds) when the operation started
- **`endTime`**: Unix timestamp (milliseconds) when the operation completed
- **`durationMs`**: Total duration of the operation in milliseconds
- **`totalFiles`**: Total number of SID files processed
- **`autoTaggedCount`**: Number of files tagged entirely by automation
- **`manualOnlyCount`**: Number of files with complete manual tags (no predictions needed)
- **`mixedCount`**: Number of files with both manual and auto-generated tags
- **`predictionsGenerated`**: Number of predictions generated by the ML model

The `predictionsGenerated` metric is particularly useful for understanding the computational load of a classification run. Files with complete manual tags don't require predictions, which saves time.

## CLI Output Format

When running `sidflow classify`, the CLI displays metrics in a human-readable format:

```
Classification complete.
WAV Cache Build:
  Files processed: 150
  Rendered: 10
  Skipped (cached): 140
  Cache hit rate: 93.3%
  Duration: 45.23s

Auto-tagging:
  Files processed: 150
  Auto-tagged: 75
  Manual-only: 50
  Mixed: 25
  Predictions generated: 100
  Metadata files: 150
  Tag files: 15
  Duration: 2m 15s
```

### Duration Format

Durations are formatted as:
- `{n}ms` for times under 1 second
- `{n}s` for times under 60 seconds (e.g., "45.23s")
- `{m}m {s}s` for times 60 seconds or longer (e.g., "2m 15s")

## Performance Optimization Tips

### Improving WAV Cache Performance

1. **Avoid `--force-rebuild`**: Only use this flag when necessary, as it invalidates the entire cache
2. **Incremental Updates**: Run `sidflow fetch` before `sidflow classify` to minimize the number of new/changed SID files
3. **Parallel Processing**: Future versions may support parallel WAV rendering using the `threads` configuration option

### Improving Auto-Tagging Performance

1. **Manual Tagging**: Files with complete manual tags skip the prediction step entirely
2. **Mixed Tagging**: Provide manual ratings for dimensions you're confident about; the system will only predict missing dimensions
3. **Batch Processing**: Process large HVSC subtrees in a single run rather than multiple small runs to amortize startup costs

## Programmatic Access

When using the TypeScript API directly, metrics are available in the return values:

```typescript
import { buildWavCache, generateAutoTags } from '@sidflow/classify';

const plan = await planClassification({ configPath: '.sidflow.json' });

// Build WAV cache
const wavResult = await buildWavCache(plan);
console.log(`Cache hit rate: ${(wavResult.metrics.cacheHitRate * 100).toFixed(1)}%`);
console.log(`Duration: ${wavResult.metrics.durationMs}ms`);

// Generate auto-tags
const tagsResult = await generateAutoTags(plan);
console.log(`Predictions generated: ${tagsResult.metrics.predictionsGenerated}`);
console.log(`Duration: ${tagsResult.metrics.durationMs}ms`);
```

## Future Enhancements

Future versions of SIDFlow may track additional metrics:

- Per-file processing times to identify slow files
- Network bandwidth usage during HVSC synchronization
- Model inference latency for ML-based predictions
- Detailed breakdown of time spent in each pipeline stage

These metrics will be documented in this file as they become available.
