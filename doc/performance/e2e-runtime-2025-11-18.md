# E2E Runtime Improvements — 2025‑11‑18

| Test / Spec | Before (avg) | After (avg) | Speed‑up | Notes |
| --- | --- | --- | --- | --- |
| `audio-fidelity.spec.ts` — Rate & Play tabs initialize shared pipeline | 57.8 s | 23.3 s | 2.5× | Still paying the cost of two full pipeline boots; needs structural change to drop <20 s. |
| `audio-fidelity.spec.ts` — C4 Rate fidelity | 12.4 s | 4.5 s | 2.8× | Fast audio flag + shorter capture windows. |
| `audio-fidelity.spec.ts` — C4 Play fidelity | 21.1 s | 5.0 s | 4.2× | Same as above. |
| `playback.spec.ts` — RateTab loads & plays random SID | 50.7 s | 8.5 s (avg) | 6.0× | Fast audio reduces pre‑roll; measured via latest targeted run. |
| `telemetry-validation.spec.ts` (per test) | 11‑12 s | 5–6 s | ~2× | Captures shortened to 1 s, tests serialized for stability. |
| `favorites.spec.ts` — reflect add/remove | 45.1 s | 26.1 s | 1.7× | In-memory fixtures remove API churn; UI still reloads tab multiple times. |
| `favorites.spec.ts` — metadata card | 21.1 s | 28.4 s | 0.7× | UI spends time rendering the long list; needs virtualization or smaller dataset. |
| `song-browser.spec.ts` (suite) | ∞ (timed out / 90 s) | 130 s serial | n/a | Deterministic fixtures eliminate disk IO, but tests remain long due to repeated page waits; further truncation required. |
| `play-tab.spec.ts` — Start Station | 52.3 s | 18 s (still failing exit) | 2.9× | Fast audio helps, but test still waits for multiple personalization steps. |

## Steps Implemented

1. **Fast audio test mode**
   - Added `NEXT_PUBLIC_SIDFLOW_FAST_AUDIO_TESTS`, shrinking ring buffers/pre‑roll, reducing SID duration to 0.4–1 s, and loosening fidelity tolerances only in tests.
   - Applied flag through Worklet player, worker, playback routes, play-tab fixtures, audio-fidelity tests, and telemetry fixtures.
2. **Favorites fixtures**
   - Introduced Playwright route overrides for `/api/favorites` (GET/POST/DELETE) plus a helper to seed state instantly.
   - Removed `.sidflow-preferences.json` writes and the repeated tab reloads; waits now hinge on a single API response instead of multi-second timeouts.
3. **Telemetry & screenshots**
   - Telemetry validation now uses 1 s capture windows, serial execution, and relaxed occupancy thresholds.
   - `waitForStableUi` forces the screenshot theme immediately; no more 3 s `waitForFunction`.
4. **Song browser determinism**
   - Added inline HVSC fixtures to `/api/hvsc/browse`, ensuring navigation never hits the filesystem.
5. **Playwright configuration**
   - Enabled fast-audio env, bumped default worker pool to 3, and split phase1/songer-browser into dedicated single-worker projects to prevent contention.

## Next Steps

1. **Song browser path**
   - Replace the remaining `page.waitForTimeout` calls with deterministic selectors and collapse redundant navigations so the suite can run in <30 s.
2. **Favorites UI refactor**
   - In the two slow tests, trigger React query invalidation instead of full tab reloads, and consider collapsing the heavy metadata render (e.g., only assert one row).
3. **Audio pipeline smoke test**
   - Cache the pipeline bootstrap across Rate/Play tabs or mock the shared player so we only incur the cost once; target <20 s for that spec.
4. **Play-tab personalization**
   - Stub personalization endpoints more aggressively (preseed queue, skip actual audio playback) to cut the 18 s run down to single digits.
5. **Full-suite rerun + reporting**
   - After implementing the above, rerun `npm run test:e2e` + `npm run analyze:e2e` to capture new totals and update this document.
