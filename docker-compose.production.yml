# SIDFlow Production Docker Compose Configuration
# Optimized for Raspberry Pi and lightweight production deployments
#
# Usage:
#   1. Copy .env.example to .env and configure your settings
#   2. Create required directories (see doc/deployment.md)
#   3. Run: docker compose -f docker-compose.production.yml up -d
#
# For Cloudflare Tunnel access, configure tunnel to proxy to localhost:3000
# No SSL/TLS configuration needed as Cloudflare handles encryption

services:
  sidflow:
    image: ghcr.io/chrisgleissner/sidflow:latest
    container_name: sidflow
    restart: unless-stopped
    
    # Security hardening
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETUID
      - SETGID
      - NET_BIND_SERVICE
    read_only: true
    user: "1001:1001"
    
    # Resource limits (adjust for your Raspberry Pi model)
    # Pi 4 (4GB+): Leave as is
    # Pi 4 (2GB): Reduce memory_limit to 1g
    # Pi 3: Reduce memory_limit to 768m, cpus to 2
    deploy:
      resources:
        limits:
          cpus: "4"
          memory: 2g
        reservations:
          cpus: "1"
          memory: 512m
    
    ports:
      - "3000:3000"
    
    environment:
      - NODE_ENV=production
      - SIDFLOW_ADMIN_USER=${SIDFLOW_ADMIN_USER:-admin}
      - SIDFLOW_ADMIN_PASSWORD=${SIDFLOW_ADMIN_PASSWORD:?SIDFLOW_ADMIN_PASSWORD is required}
      - SIDFLOW_ADMIN_SECRET=${SIDFLOW_ADMIN_SECRET:-}
      - SIDFLOW_ROOT=/sidflow
      - SIDFLOW_CONFIG=/sidflow/.sidflow.json
      # Optional: Ultimate 64 hardware password
      - ULTIMATE64_PASSWORD=${ULTIMATE64_PASSWORD:-}
    
    volumes:
      # Application data - persisted across container updates
      # Mount HVSC/SID collection as read-only (never written to by SIDFlow)
      - ${SIDFLOW_SID_PATH:-./data/hvsc}:/sidflow/workspace/hvsc:ro
      # WAV cache - rendered audio files (can be regenerated)
      - ${SIDFLOW_WAV_CACHE:-./data/wav-cache}:/sidflow/workspace/wav-cache
      # Tags - user ratings and tags (important, backup recommended)
      - ${SIDFLOW_TAGS_PATH:-./data/tags}:/sidflow/workspace/tags
      # Data directory - classified data, LanceDB, availability manifests
      - ${SIDFLOW_DATA_PATH:-./data/sidflow}:/sidflow/data
      
      # Temporary filesystem for runtime needs (read-only root requires this)
      - type: tmpfs
        target: /tmp
        tmpfs:
          size: 100M
          mode: 1777
    
    # Health check using the /api/health endpoint
    # Note: curl is included in the production image (see Dockerfile.production)
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
        tag: "{{.Name}}"

# Named volumes for better Docker management (optional alternative to bind mounts)
# Uncomment and modify the volumes section above if you prefer Docker-managed volumes
# volumes:
#   sidflow-hvsc:
#   sidflow-wav-cache:
#   sidflow-tags:
#   sidflow-data:
