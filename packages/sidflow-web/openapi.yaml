openapi: 3.0.3
info:
  title: SIDFlow Web API
  description: |
    Local web interface for orchestrating SID playback, rating, and classification.
    
    This API provides endpoints that delegate to existing CLI tools where applicable:
    - `sidflow-play` - Create client-side playback sessions with mood-based presets
    - `sidflow-rate` - Submit manual ratings for tracks
    - `sidflow-classify` - Classify SID files using ML models
    - `sidflow-fetch` - Synchronize HVSC collection
    - `sidflow-train` - Train ML models on feedback data
  version: 0.1.0
  license:
    name: GPL-2.0-only
    url: https://www.gnu.org/licenses/old-licenses/gpl-2.0.html

servers:
  - url: https://sidflow.local
    description: Default SIDFlow web deployment (override per environment)

security: []

tags:
  - name: playback
    description: SID music playback operations
  - name: rating
    description: Track rating operations
  - name: classification
    description: Audio classification operations
  - name: sync
    description: HVSC collection synchronization
  - name: training
    description: ML model training operations

paths:
  /api/play:
    post:
      tags:
        - playback
      summary: Create playback session
      description: Creates a session descriptor for client-side SID playback with optional mood preset
      operationId: playSid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PlayRequest'
            examples:
              withPreset:
                summary: Play with mood preset
                value:
                  sid_path: /path/to/music.sid
                  preset: energetic
              withoutPreset:
                summary: Play without preset
                value:
                  sid_path: /path/to/music.sid
      responses:
        '200':
          description: Playback session created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlaybackSessionResponse'
        '400':
          $ref: '#/components/responses/ValidationError'
        '500':
          $ref: '#/components/responses/CommandError'

  /api/rate:
    post:
      tags:
        - rating
      summary: Rate a SID track
      description: Submit manual ratings for energy, mood, complexity, and preference via sidflow-rate CLI
      operationId: rateSid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RateRequest'
            example:
              sid_path: /path/to/music.sid
              ratings:
                e: 4
                m: 3
                c: 5
                p: 4
      responses:
        '200':
          description: Rating submitted successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          message:
                            type: string
                            example: Rating submitted successfully
        '400':
          $ref: '#/components/responses/ValidationError'
        '500':
          $ref: '#/components/responses/CommandError'

  /api/classify:
    post:
      tags:
        - classification
      summary: Classify SID files
      description: Trigger classification on a directory of SID files via sidflow-classify CLI
      operationId: classifySids
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ClassifyRequest'
            example:
              path: /path/to/sid/directory
      responses:
        '200':
          description: Classification completed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400':
          $ref: '#/components/responses/ValidationError'
        '500':
          $ref: '#/components/responses/CommandError'

  /api/fetch:
    post:
      tags:
        - sync
      summary: Synchronize HVSC collection
      description: Download and sync the High Voltage SID Collection via sidflow-fetch CLI
      operationId: fetchHvsc
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FetchRequest'
            examples:
              default:
                summary: Default sync
                value: {}
              custom:
                summary: Custom configuration
                value:
                  configPath: /path/to/config.json
                  remoteBaseUrl: https://mirror.example.com/hvsc
                  hvscVersionPath: /custom/version.json
      responses:
        '200':
          description: Sync completed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400':
          $ref: '#/components/responses/ValidationError'
        '500':
          $ref: '#/components/responses/CommandError'

  /api/train:
    post:
      tags:
        - training
      summary: Train ML model
      description: Train the machine learning model on feedback data via sidflow-train CLI
      operationId: trainModel
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TrainRequest'
            examples:
              default:
                summary: Default training
                value: {}
              custom:
                summary: Custom training parameters
                value:
                  epochs: 20
                  batchSize: 32
                  learningRate: 0.0005
                  evaluate: true
                  force: false
      responses:
        '200':
          description: Training completed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400':
          $ref: '#/components/responses/ValidationError'
        '500':
          $ref: '#/components/responses/CommandError'

components:
  schemas:
    PlayRequest:
      type: object
      required:
        - sid_path
      properties:
        sid_path:
          type: string
          description: Absolute path to the SID file
          minLength: 1
          example: /home/user/hvsc/MUSICIANS/H/Hubbard_Rob/Commando.sid
        preset:
          type: string
          description: Mood preset for playlist generation
          enum:
            - quiet
            - ambient
            - energetic
            - dark
            - bright
            - complex
          example: energetic

    RateTrackMetadata:
      type: object
      required:
        - songs
        - startSong
        - sidType
        - version
        - sidModel
        - clock
        - fileSizeBytes
      properties:
        title:
          type: string
          description: SID title parsed from metadata
          example: Commando
        author:
          type: string
          description: Primary author or composer
          example: Rob Hubbard
        released:
          type: string
          description: Release year or label information
          example: '1985'
        songs:
          type: integer
          description: Total number of subtunes contained in the SID file
          example: 3
        startSong:
          type: integer
          description: Default subtune index (1-based)
          example: 1
        sidType:
          type: string
          description: SID file type identifier (PSID/Rsid)
          example: PSID
        version:
          type: integer
          description: SID file version
          example: 2
        sidModel:
          type: string
          description: Primary SID model requested by the tune
          example: MOS6581
        sidModelSecondary:
          type: string
          description: Optional secondary SID model requirement
          example: MOS8580
        sidModelTertiary:
          type: string
          description: Optional tertiary SID model requirement
        clock:
          type: string
          description: Target clock configuration (PAL/NTSC)
          example: PAL
        length:
          type: string
          description: Human-readable track length hint (mm:ss)
          example: 03:12
        fileSizeBytes:
          type: integer
          format: int64
          description: Size of the SID file in bytes
          example: 42518

    RateTrackInfo:
      type: object
      required:
        - sidPath
        - relativePath
        - filename
        - displayName
        - selectedSong
        - metadata
        - durationSeconds
      properties:
        sidPath:
          type: string
          description: Absolute path to the SID file on disk
          example: /home/user/hvsc/MUSICIANS/H/Hubbard_Rob/Commando.sid
        relativePath:
          type: string
          description: Path to the SID relative to the configured collection root
          example: MUSICIANS/H/Hubbard_Rob/Commando.sid
        filename:
          type: string
          description: Filename derived from the SID path
          example: Commando.sid
        displayName:
          type: string
          description: Friendly display name for UI presentation
          example: Commando (Rob Hubbard)
        selectedSong:
          type: integer
          description: Currently selected subtune index (1-based)
          example: 1
        metadata:
          $ref: '#/components/schemas/RateTrackMetadata'
        durationSeconds:
          type: number
          format: float
          description: Estimated duration of the selected subtune in seconds
          example: 192

    PlaybackSession:
      type: object
      required:
        - sessionId
        - sidUrl
        - scope
        - durationSeconds
        - selectedSong
        - expiresAt
      properties:
        sessionId:
          type: string
          description: Unique identifier for the playback session
          example: 3f61f45a-1cdf-4f77-9b27-d76f38e5d2c7
        sidUrl:
          type: string
          description: Relative URL used to fetch the SID binary for this session
          example: /api/playback/3f61f45a-1cdf-4f77-9b27-d76f38e5d2c7/sid
        scope:
          type: string
          description: Context that created the session (rate/play/manual)
          enum:
            - rate
            - play
            - manual
          example: play
        durationSeconds:
          type: number
          format: float
          description: Estimated duration of the selected subtune in seconds
          example: 192
        selectedSong:
          type: integer
          description: Currently selected subtune index (1-based)
          example: 1
        expiresAt:
          type: string
          format: date-time
          description: ISO-8601 timestamp when the session will expire
          example: 2025-11-09T12:34:56.000Z

    PlaybackSessionResponse:
      type: object
      required:
        - success
        - data
      properties:
        success:
          type: boolean
          enum:
            - true
          example: true
        data:
          type: object
          required:
            - track
            - session
          properties:
            track:
              $ref: '#/components/schemas/RateTrackInfo'
            session:
              $ref: '#/components/schemas/PlaybackSession'

    RateRequest:
      type: object
      required:
        - sid_path
        - ratings
      properties:
        sid_path:
          type: string
          description: Absolute path to the SID file
          minLength: 1
          example: /home/user/hvsc/MUSICIANS/H/Hubbard_Rob/Commando.sid
        ratings:
          type: object
          required:
            - e
            - m
            - c
            - p
          properties:
            e:
              type: integer
              description: Energy rating (1-5)
              minimum: 1
              maximum: 5
              example: 4
            m:
              type: integer
              description: Mood rating (1-5)
              minimum: 1
              maximum: 5
              example: 3
            c:
              type: integer
              description: Complexity rating (1-5)
              minimum: 1
              maximum: 5
              example: 5
            p:
              type: integer
              description: Preference rating (1-5)
              minimum: 1
              maximum: 5
              example: 4

    ClassifyRequest:
      type: object
      required:
        - path
      properties:
        path:
          type: string
          description: Path to directory containing SID files to classify
          minLength: 1
          example: /home/user/hvsc/MUSICIANS/H

    FetchRequest:
      type: object
      properties:
        configPath:
          type: string
          description: Path to custom .sidflow.json configuration file
          example: /path/to/config.json
        remoteBaseUrl:
          type: string
          format: uri
          description: Override HVSC mirror base URL
          example: https://www.hvsc.de/downloads/C64Music
        hvscVersionPath:
          type: string
          description: Custom location for hvsc-version.json
          example: /path/to/version.json

    TrainRequest:
      type: object
      properties:
        configPath:
          type: string
          description: Path to custom .sidflow.json configuration file
          example: /path/to/config.json
        epochs:
          type: integer
          description: Number of training epochs
          minimum: 1
          example: 10
        batchSize:
          type: integer
          description: Training batch size
          minimum: 1
          example: 16
        learningRate:
          type: number
          description: Learning rate for training
          minimum: 0
          example: 0.001
        evaluate:
          type: boolean
          description: Whether to evaluate on test set
          default: true
          example: true
        force:
          type: boolean
          description: Force complete retraining from scratch
          default: false
          example: false

    SuccessResponse:
      type: object
      required:
        - success
        - data
      properties:
        success:
          type: boolean
          enum:
            - true
          example: true
        data:
          type: object
          properties:
            output:
              type: string
              description: Standard output from CLI command
              example: "Playlist generated successfully\nPlaying: Commando.sid\n"

    ErrorResponse:
      type: object
      required:
        - success
        - error
      properties:
        success:
          type: boolean
          enum:
            - false
          example: false
        error:
          type: string
          description: Error message
          example: Validation error
        details:
          type: string
          description: Additional error details
          example: "sid_path: SID path is required"

  responses:
    ValidationError:
      description: Request validation failed
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            error: Validation error
            details: "ratings.e: Expected integer, received string"

    CommandError:
      description: CLI command execution failed
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            error: Playback command failed
            details: "Error: SID file not found"
